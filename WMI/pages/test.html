%WMI_STYLE%
%WMI_NAVBAR%
<style>
  [id=usage] .card {
    min-height: 300px;
  }

  a.btn {
    color: white;
  }

  pre {
    white-space: pre-wrap;
    /* Since CSS 2.1 */
    white-space: -moz-pre-wrap;
    /* Mozilla, since 1999 */
    white-space: -pre-wrap;
    /* Opera 4-6 */
    white-space: -o-pre-wrap;
    /* Opera 7 */
    word-wrap: break-word;
    /* Internet Explorer 5.5+ */
    text-align: left;
  }
</style>
<!--Content Here-->
<div>
  <h1 itemprop="name">Simple Websocket Writen in PHP and Javascript</h1>
  <img itemprop="image" src="https://res.cloudinary.com/dimaslanjaka/image/fetch/https://bertzzie.com/knowledge/javascript-lanjut/_images/AJAXvsWebSocket.png"
    alt="Websocket How to" class="d-none" />
  <h5 class="ml-3"><i class="fab fa-js mr-1"></i><span class="badge badge-info">Javascript</span><a
      href="https://github.com/dimaslanjaka/Web-Manajemen/blob/master/js/websocket.js" target="_blank"
      rel="noopener noreferrer" class="btn btn-success btn-sm ml-1" title="JS">Download<i
        class="fas fa-download ml-1"></i></a></h5>
  <pre lang="javascript">
    /**
    * Simple Websocket javascript
    * @todo Live Data
    * @description Don&apos;t miss data that changes even for a second
    * @author Dimas Lanjaka &lt;dimaslanjaka[at]gmail.com
    */

   /**
   USAGE:
   if (conditional) {
     socket_start();
   }
   */
   function socket_start() {
     if (!socket) {
       console.log(&apos;WebSocket Started&apos;);
       socket = socket_server();
     }
     try {
       socket.onopen = function (msg) {
         console.log(&apos;socket initialized&apos;);
       };
       socket.onmessage = function (msg) {
         var data = JSON.parse(msg.data);
         //do with data response
         console.log(data);
       };
       socket.onclose = function (msg) {
         console.log({ closed: socket });
       };
     }
     catch (ex) {
       console.log(ex);
     }
   }

   function socket_server() {
     console.log(&apos;Socket Initialized&apos;);
     var host = &apos;/ajax/server&apos;;
     if (!window.EventSource) {
       var socket = new EventSource(host);
     } else {
       var socket = new WebSocket(host);
     }
     return socket;
   }

   function socket_stop() {
     if (socket != null) {
       console.log(&quot;WebSocket Stopped&quot;);
       socket.close();
       socket = null;
     }
   }

   function socket_check() {
     return socket;
   }

  </pre>
  <h6 class="text-center">JS Usage Example</h6>
  <div class="row" id="usage">
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">By Variable OR Const</h5>
          <pre class="card-text">
const start_socket = false;
if (start_socket){
  socket_start();
}
      </pre>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">By Element Exists</h5>
          <pre class="card-text">
var websocketElement = document.getElementById('websocket'); //find any elements with id websocket
if (websocketElement){
  socket_start();
}
      </pre>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Others</h5>
          <p class="card-text">
            You can use it as your wish.
          </p>
        </div>
      </div>
    </div>
  </div>

  <h5 class="ml-3"><i class="fab fa-php mr-1"></i><span class="badge badge-info">PHP</span><a
      href="https://github.com/dimaslanjaka/Web-Manajemen/blob/master/PHP/websocket.php" target="_blank"
      rel="noopener noreferrer" class="btn btn-success btn-sm ml-1" title="PHP">Download<i
        class="fas fa-download ml-1"></i></a></h5>
  <pre lang="php">
  &lt;?php

/**
 * Websocket server.
 *
 * @author dimaslanjaka &lt;dimaslanjaka@gmail.com&gt;
 *
 * @todo receiving websocket and return all data to be live
 *
 * @version 1.4.6
 *
 * @since 1.0.0
 * @see https://www.webmanajemen.com/2020/01/simple-websocket.html Simple Web Socket
 *
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 */
class WMI_websocket
{
  /**
   * Data Storage.
   *
   * @var array
   */
  private $data = [];
  /**
   * Chaining static OOP initializer.
   *
   * @var mixed
   */
  private static $_instance = null;

  /**
   * Websocket Header Initializer.
   *
   * @param bool $allow_global_domain Allowing Websocket from any domains
   * @param bool $cache               Allow Caching ? better no
   */
  public function __construct($allow_global_domain = false, $cache = false)
  {
    /*
     * Disable Bot Crawlers
     */
    header(&apos;X-Robots-Tag: noindex, nofollow&apos;, true);
    header(&apos;Content-Type: text/event-stream&apos;);
    if (!$cache) {
      header(&apos;Cache-Control: no-store, no-cache, must-revalidate, max-age=0&apos;);
      header(&apos;Cache-Control: post-check=0, pre-check=0&apos;, false);
      header(&apos;Cache-Control: no-cache&apos;);
    }
    if (isset($_SERVER[&apos;HTTP_SEC_WEBSOCKET_KEY&apos;])) {
      header(&apos;Connection: Upgrade&apos;);
      header(&apos;HTTP/1.1 101 Web Socket Protocol Handshake&apos;);
      header(&apos;Host: &apos; . $_SERVER[&apos;SERVER_NAME&apos;]);
      header(&apos;X-Accel-Buffering: no&apos;);
      header(&apos;Upgrade: websocket&apos;);
      header(&apos;WebSocket-Origin: &apos; . $_SERVER[&apos;SERVER_NAME&apos;]);
      /**
       * Set canonical response.
       */
      $canonical = (isset($_SERVER[&apos;HTTPS&apos;]) &amp;&amp; &apos;on&apos; === $_SERVER[&apos;HTTPS&apos;] ? &apos;https&apos; : &apos;http&apos;) . &apos;://&apos; . $_SERVER[&apos;HTTP_HOST&apos;] . strtok($_SERVER[&apos;REQUEST_URI&apos;], &apos;?&apos;);
      header(&apos;WebSocket-Location: &apos; . $canonical);
      $_SESSION[&apos;serv&apos;] = $_SERVER;
      /*
       * @todo Encrypting Websocket Hash
       */
      header(&apos;Sec-WebSocket-Accept: &apos; . base64_encode(pack(&apos;H*&apos;, sha1($_SERVER[&apos;HTTP_SEC_WEBSOCKET_KEY&apos;] . &apos;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&apos;))));
    }
    if ($allow_global_domain) {
      header(&apos;Access-Control-Allow-Origin: *&apos;);
    }
  }

  /**
   * Chaining static OOP.
   *
   * @return self::$_instance
   */
  public static function i()
  {
    if (null === self::$_instance) {
      self::$_instance = new self();
    }

    return self::$_instance;
  }

  /**
   * Output data for javascript processing.
   *
   * @return void
   */
  public function SEND()
  {
    $data = [&apos;msg&apos; =&gt; &apos;server time: &apos; . date(&apos;h:i:s&apos;, time())];
    //$parse_url = parse_url($_SERVER[&apos;HTTP_REFERER&apos;]);
    $data = $this-&gt;data;
    echo &apos;id: &apos; . time() . PHP_EOL;
    $data = json_encode($data);
    echo &quot;data: $data&quot; . PHP_EOL;
    echo PHP_EOL;
    ob_flush();
    flush();
  }

  /**
   * Data Processing Unit
   * * Also can be chained OOP.
   *
   * @param array $data
   *
   * @return array
   */
  public function createData(array $data)
  {
    $this-&gt;data = $data;

    return $this;
  }
}
</pre>

  <div class="row" id="usage">
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">PHP Normal Usage</h5>
          <pre class="card-text">
$websocket = new WMI_websocket(false, false);
/* Data Example */
$websocket-&gt;createData([
  &apos;pendapatan_max_invoice&apos; =&gt; 45,
  &apos;piutang_max_invoice&apos; =&gt; 55,
  &apos;hutang_max_invoice&apos; =&gt; 65,
  &apos;pengeluaran_max_invoice&apos; =&gt; 67,
]);
$websocket-&gt;SEND();
        </pre>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">PHP Object Oriented Usage</h5>
          <pre class="card-text">
$websocket = new WMI_websocket(false, false);
$websocket-&gt;createData([
  &apos;pendapatan_max_invoice&apos; =&gt; 45,
  &apos;piutang_max_invoice&apos; =&gt; 55,
  &apos;hutang_max_invoice&apos; =&gt; 65,
  &apos;pengeluaran_max_invoice&apos; =&gt; 67,
])-&gt;SEND();
        </pre>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">PHP <b>Static</b> Object Oriented Usage</h5>
          <pre class="card-text">
WMI_websocket::i(false, false)-&gt;createData([
  &apos;pendapatan_max_invoice&apos; =&gt; 45,
  &apos;piutang_max_invoice&apos; =&gt; 55,
  &apos;hutang_max_invoice&apos; =&gt; 65,
  &apos;pengeluaran_max_invoice&apos; =&gt; 67,
])-&gt;SEND();
        </pre>
        </div>
      </div>
    </div>
  </div>

</div>

%WMI_FOOTER%