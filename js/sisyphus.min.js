/**
 * Plugin developed to save html forms data to LocalStorage to restore them after browser crashes, tabs closings
 * and other disasters.
 *
 * https://github.com/simsalabim/sisyphus
 *
 * @author Alexander Kaupanin <kaupanin@gmail.com>
 * @license MIT - see https://github.com/simsalabim/sisyphus/blob/master/MIT-LICENSE
 */
!function($){function getElementIdentifier(el){return"[id="+el.attr("id")+"][name="+el.attr("name")+"]"}$.fn.sisyphus=function(options){var identifier=$.map(this,(function(obj){return getElementIdentifier($(obj))})).join(),sisyphus=Sisyphus.getInstance(identifier);return sisyphus.protect(this,options),sisyphus};var browserStorage={isAvailable:function(){if("object"==typeof $.jStorage)return!0;try{return localStorage.getItem}catch(e){return!1}},set:function(key,value){if("object"==typeof $.jStorage)$.jStorage.set(key,value+"");else try{localStorage.setItem(key,value+"")}catch(e){}},get:function(key){if("object"==typeof $.jStorage){var result=$.jStorage.get(key);return result?result.toString():result}return localStorage.getItem(key)},remove:function(key){"object"==typeof $.jStorage?$.jStorage.deleteKey(key):localStorage.removeItem(key)}};Sisyphus=function(){var params={instantiated:[],started:[]},CKEDITOR=window.CKEDITOR;function init(){return{setInstanceIdentifier:function(identifier){this.identifier=identifier},getInstanceIdentifier:function(){return this.identifier},setInitialOptions:function(options){var defaults={excludeFields:[],customKeySuffix:"",locationBased:!1,timeout:0,autoRelease:!0,onBeforeSave:function(){},onSave:function(){},onBeforeRestore:function(){},onRestore:function(){},onRelease:function(){}};this.options=this.options||$.extend(defaults,options),this.browserStorage=browserStorage},setOptions:function(options){this.options=this.options||this.setInitialOptions(options),this.options=$.extend(this.options,options)},protect:function(targets,options){this.setOptions(options),targets=targets||{};var self=this;if(this.targets=this.targets||[],self.options.name?this.href=self.options.name:this.href=location.hostname+location.pathname+location.search+location.hash,this.targets=$.merge(this.targets,targets),this.targets=$.unique(this.targets),this.targets=$(this.targets),!this.browserStorage.isAvailable())return!1;var callback_result=self.options.onBeforeRestore.call(self);if((void 0===callback_result||callback_result)&&self.restoreAllData(),this.options.autoRelease&&self.bindReleaseData(),!params.started[this.getInstanceIdentifier()])if(self.isCKEditorPresent())var intervalId=setInterval((function(){CKEDITOR.isLoaded&&(clearInterval(intervalId),self.bindSaveData(),params.started[self.getInstanceIdentifier()]=!0)}),100);else self.bindSaveData(),params.started[self.getInstanceIdentifier()]=!0},isCKEditorPresent:function(){return!!this.isCKEditorExists()&&(CKEDITOR.isLoaded=!1,CKEDITOR.on("instanceReady",(function(){CKEDITOR.isLoaded=!0})),!0)},isCKEditorExists:function(){return void 0!==CKEDITOR},findFieldsToProtect:function(target){return target.find(":input").not(":submit").not(":reset").not(":button").not(":file").not(":password").not(":disabled").not("[readonly]")},bindSaveData:function(){var self=this;self.options.timeout&&self.saveDataByTimeout(),self.targets.each((function(){var targetFormIdAndName=getElementIdentifier($(this));self.findFieldsToProtect($(this)).each((function(){if(-1!==$.inArray(this,self.options.excludeFields))return!0;var field=$(this),prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+getElementIdentifier(field)+self.options.customKeySuffix;(field.is(":text")||field.is("textarea"))&&(self.options.timeout||self.bindSaveDataImmediately(field,prefix)),self.bindSaveDataOnChange(field)}))}))},saveAllData:function(){var self=this;self.targets.each((function(){var targetFormIdAndName=getElementIdentifier($(this)),multiCheckboxCache={};self.findFieldsToProtect($(this)).each((function(){var field=$(this);if(-1!==$.inArray(this,self.options.excludeFields)||void 0===field.attr("name")&&void 0===field.attr("id"))return!0;var prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+getElementIdentifier(field)+self.options.customKeySuffix,value=field.val();if(field.is(":checkbox")){var name=field.attr("name");if(void 0!==name&&-1!==name.indexOf("[")){if(!0===multiCheckboxCache[name])return;value=[],$("[name='"+name+"']:checked").each((function(){value.push($(this).val())})),multiCheckboxCache[name]=!0}else value=field.is(":checked");self.saveToBrowserStorage(prefix,value,!1)}else if(field.is(":radio"))field.is(":checked")?(value=field.val(),self.saveToBrowserStorage(prefix,value,!1)):self.browserStorage.remove(prefix);else if(self.isCKEditorExists()){var editor=CKEDITOR.instances[field.attr("name")]||CKEDITOR.instances[field.attr("id")];editor?(editor.updateElement(),self.saveToBrowserStorage(prefix,field.val(),!1)):self.saveToBrowserStorage(prefix,value,!1)}else self.saveToBrowserStorage(prefix,value,!1)}))})),self.options.onSave.call(self)},restoreAllData:function(){var self=this,restored=!1;self.targets.each((function(){var target=$(this),targetFormIdAndName=getElementIdentifier($(this));self.findFieldsToProtect(target).each((function(){if(-1!==$.inArray(this,self.options.excludeFields))return!0;var field=$(this),prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+getElementIdentifier(field)+self.options.customKeySuffix,resque=self.browserStorage.get(prefix);null!==resque&&(self.restoreFieldsData(field,resque),restored=!0)}))})),restored&&self.options.onRestore.call(self)},restoreFieldsData:function(field,resque){if(void 0===field.attr("name")&&void 0===field.attr("id"))return!1;var name=field.attr("name");!field.is(":checkbox")||"false"===resque||void 0!==name&&-1!==name.indexOf("[")?!field.is(":checkbox")||"false"!==resque||void 0!==name&&-1!==name.indexOf("[")?field.is(":radio")?field.val()===resque&&field.prop("checked",!0):void 0===name||-1===name.indexOf("[")?field.val(resque):(resque=resque.split(","),field.val(resque)):field.prop("checked",!1):field.prop("checked",!0)},bindSaveDataImmediately:function(field,prefix){var self=this;if("onpropertychange"in field?field.get(0).onpropertychange=function(){self.saveToBrowserStorage(prefix,field.val())}:field.get(0).oninput=function(){self.saveToBrowserStorage(prefix,field.val())},this.isCKEditorExists()){var editor=CKEDITOR.instances[field.attr("name")]||CKEDITOR.instances[field.attr("id")];editor&&editor.document.on("keyup",(function(){editor.updateElement(),self.saveToBrowserStorage(prefix,field.val())}))}},saveToBrowserStorage:function(key,value,fireCallback){var self=this,callback_result=this.options.onBeforeSave.call(this);void 0!==callback_result&&!1===callback_result||(fireCallback=void 0===fireCallback||fireCallback,this.browserStorage.set(key,value),fireCallback&&""!==value&&this.options.onSave.call(this))},bindSaveDataOnChange:function(field){var self=this;field.change((function(){self.saveAllData()}))},saveDataByTimeout:function(){var self=this,targetForms=self.targets;setTimeout(function(){function timeout(){self.saveAllData(),setTimeout(timeout,1e3*self.options.timeout)}return timeout}(targetForms),1e3*self.options.timeout)},bindReleaseData:function(){var self=this;self.targets.each((function(){var target=$(this),formIdAndName=getElementIdentifier(target);$(this).bind("submit reset",(function(){self.releaseData(formIdAndName,self.findFieldsToProtect(target))}))}))},manuallyReleaseData:function(){var self=this;self.targets.each((function(){var target=$(this),formIdAndName=getElementIdentifier(target);self.releaseData(formIdAndName,self.findFieldsToProtect(target))}))},releaseData:function(targetFormIdAndName,fieldsToProtect){var released=!1,self=this;params.started[self.getInstanceIdentifier()]=!1,fieldsToProtect.each((function(){if(-1!==$.inArray(this,self.options.excludeFields))return!0;var field=$(this),prefix=(self.options.locationBased?self.href:"")+targetFormIdAndName+getElementIdentifier(field)+self.options.customKeySuffix;self.browserStorage.remove(prefix),released=!0})),released&&self.options.onRelease.call(self)}}}return{getInstance:function(identifier){return params.instantiated[identifier]||(params.instantiated[identifier]=init(),params.instantiated[identifier].setInstanceIdentifier(identifier),params.instantiated[identifier].setInitialOptions()),params.instantiated[identifier]},free:function(){return params={instantiated:[],started:[]},null},version:"1.1.3"}}()}(jQuery);